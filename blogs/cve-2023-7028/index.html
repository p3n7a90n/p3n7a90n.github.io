<!DOCTYPE html>
<html lang="en" data-theme="dark">
    <head>
    <meta charset="UTF-8" />

    <meta name="generator" content="Hugo 0.68.3" /><meta name="theme-color" content="#16171d" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <meta name="format-detection" content="telephone=no, date=no, address=no, email=no" />
    
    <meta http-equiv="Cache-Control" content="no-transform" />
    
    <meta http-equiv="Cache-Control" content="no-siteapp" />

    <title>Reversing CVE-2023-7028 &amp; Discovering Another Possible Account Takeover By Using Private Commit Email | p3n7a90n</title>

    <link rel="stylesheet" href="/css/meme.min.82382c86f87cf87b5b53406251018e77569171b25295c38fca025288034c3fce.css"/>

    
    
        <script src="/js/meme.min.5904c5511e2bf2b3c70ee77c041a9796445899d071392fe900252197928ec6ee.js"></script>

    

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM&#43;Plex&#43;Serif:ital,wght@0,400;0,500;0,700;1,400;1,700&amp;family=Source&#43;Code&#43;Pro:ital,wght@0,400;0,700;1,400;1,700&amp;family=Comfortaa:wght@700&amp;display=swap" media="print" onload="this.media='all'" />
        <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM&#43;Plex&#43;Serif:ital,wght@0,400;0,500;0,700;1,400;1,700&amp;family=Source&#43;Code&#43;Pro:ital,wght@0,400;0,700;1,400;1,700&amp;family=Comfortaa:wght@700&amp;display=swap" /></noscript>

    <meta name="author" content="" /><meta name="description" content="In the security release of 11th Jan 2024, Gitlab patched a critical vulnerability “Account Takeover via Password Reset without user interactions”, for which CVE 2023-7028 was assigned.
This looked interesting, so we decided to look into the issue and the patch. This was our first time setting up the env and looking into the gitlab codebase." />

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#2a6df4" />
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="p3n7a90n" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="application-name" content="p3n7a90n" />
    <meta name="msapplication-starturl" content="../../" />
    <meta name="msapplication-TileColor" content="#fff" />
    <meta name="msapplication-TileImage" content="../../icons/mstile-150x150.png" />
    <link rel="manifest" href="/manifest.json" />

    
    

    
    <link rel="canonical" href="https://p3n7a90n.github.com/blogs/cve-2023-7028/" />
    

    
    

    
</head>

    <body>
        <div class="container">
            
    <header class="header">
        
            <div class="header-wrapper">
                <div class="header-inner single">
                    
    <div class="site-brand">
        
            <a href="/" class="brand">p3n7a90n</a>
        
    </div>

                    <nav class="nav">
    <ul class="menu" id="menu">
        
            
        
        
        
        
            
                <li class="menu-item"><a href="/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" class="icon home"><path d="M280.37 148.26L96 300.11V464a16 16 0 0 0 16 16l112.06-.29a16 16 0 0 0 15.92-16V368a16 16 0 0 1 16-16h64a16 16 0 0 1 16 16v95.64a16 16 0 0 0 16 16.05L464 480a16 16 0 0 0 16-16V300L295.67 148.26a12.19 12.19 0 0 0-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 0 0-12-12h-56a12 12 0 0 0-12 12v72.61L318.47 43a48 48 0 0 0-61 0L4.34 251.47a12 12 0 0 0-1.6 16.9l25.5 31A12 12 0 0 0 45.15 301l235.22-193.74a12.19 12.19 0 0 1 15.3 0L530.9 301a12 12 0 0 0 16.9-1.6l25.5-31a12 12 0 0 0-1.7-16.93z"/></svg><span class="menu-item-name">Home</span></a>
                </li>
            
        
            
                <li class="menu-item active"><a href="/blogs/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon archive"><path d="M32 448c0 17.7 14.3 32 32 32h384c17.7 0 32-14.3 32-32V160H32v288zm160-212c0-6.6 5.4-12 12-12h104c6.6 0 12 5.4 12 12v8c0 6.6-5.4 12-12 12H204c-6.6 0-12-5.4-12-12v-8zM480 32H32C14.3 32 0 46.3 0 64v48c0 8.8 7.2 16 16 16h480c8.8 0 16-7.2 16-16V64c0-17.7-14.3-32-32-32z"/></svg><span class="menu-item-name">Blogs</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/categories/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon th"><path d="M149.333 56v80c0 13.255-10.745 24-24 24H24c-13.255 0-24-10.745-24-24V56c0-13.255 10.745-24 24-24h101.333c13.255 0 24 10.745 24 24zm181.334 240v-80c0-13.255-10.745-24-24-24H205.333c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.333c13.256 0 24.001-10.745 24.001-24zm32-240v80c0 13.255 10.745 24 24 24H488c13.255 0 24-10.745 24-24V56c0-13.255-10.745-24-24-24H386.667c-13.255 0-24 10.745-24 24zm-32 80V56c0-13.255-10.745-24-24-24H205.333c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.333c13.256 0 24.001-10.745 24.001-24zm-205.334 56H24c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24h101.333c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24zM0 376v80c0 13.255 10.745 24 24 24h101.333c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24H24c-13.255 0-24 10.745-24 24zm386.667-56H488c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24H386.667c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24zm0 160H488c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24H386.667c-13.255 0-24 10.745-24 24v80c0 13.255 10.745 24 24 24zM181.333 376v80c0 13.255 10.745 24 24 24h101.333c13.255 0 24-10.745 24-24v-80c0-13.255-10.745-24-24-24H205.333c-13.255 0-24 10.745-24 24z"/></svg><span class="menu-item-name">Categories</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/about/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="icon user-circle"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 96c48.6 0 88 39.4 88 88s-39.4 88-88 88-88-39.4-88-88 39.4-88 88-88zm0 344c-58.7 0-111.3-26.6-146.5-68.2 18.8-35.4 55.6-59.8 98.5-59.8 2.4 0 4.8.4 7.1 1.1 13 4.2 26.6 6.9 40.9 6.9 14.3 0 28-2.7 40.9-6.9 2.3-.7 4.7-1.1 7.1-1.1 42.9 0 79.7 24.4 98.5 59.8C359.3 421.4 306.7 448 248 448z"/></svg><span class="menu-item-name">About</span></a>
                </li>
            
        
    </ul>
</nav>

                    
                </div>
            </div>
            
    <input type="checkbox" id="nav-toggle" aria-hidden="true" />
    <label for="nav-toggle" class="nav-toggle"></label>
    <label for="nav-toggle" class="nav-curtain"></label>


        
    </header>




            
            
    <main class="main single" id="main">
    <div class="main-inner">

        

        <article class="content post h-entry" data-small-caps="true" data-align="default" data-type="blogs" data-toc-num="true">

            <h1 class="post-title p-name">Reversing CVE-2023-7028 &amp; Discovering Another Possible Account Takeover By Using Private Commit Email</h1>

            

            
                
            

            
                

<div class="post-meta">
    
        
        <time datetime="2025-07-24T08:24:10&#43;04:00" class="post-meta-item published dt-published"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon post-meta-icon"><path d="M148 288h-40c-6.6 0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h48c26.5 0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3 0 6-2.7 6-6z"/></svg>&nbsp;2025.7.24</time>
    
    
    
    
        
        
        
            
                <span class="post-meta-item category"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M464 128H272l-54.63-54.63c-6-6-14.14-9.37-22.63-9.37H48C21.49 64 0 85.49 0 112v288c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48V176c0-26.51-21.49-48-48-48zm0 272H48V112h140.12l54.63 54.63c6 6 14.14 9.37 22.63 9.37H464v224z"/></svg>&nbsp;<a href="/categories/cve-reversing/" class="category-link p-category">CVE Reversing</a>/<a href="/categories/gitlab/" class="category-link p-category">Gitlab</a></span>
            
        
    
    
    
        
        <span class="post-meta-item reading-time"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 448c-110.5 0-200-89.5-200-200S145.5 56 256 56s200 89.5 200 200-89.5 200-200 200zm61.8-104.4l-84.9-61.7c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h32c6.6 0 12 5.4 12 12v141.7l66.8 48.6c5.4 3.9 6.5 11.4 2.6 16.8L334.6 349c-3.9 5.3-11.4 6.5-16.8 2.6z"/></svg>&nbsp;5&nbsp;mins</span>
    
    
    
</div>

            

            <div class="post-body e-content">
              <p style="text-indent:0"><span class="drop-cap">I</span>n the security release of <a href="https://about.gitlab.com/releases/2024/01/11/critical-security-release-gitlab-16-7-2-released/#account-takeover-via-password-reset-without-user-interactions" target="_blank" rel="noopener">11th Jan 2024</a>, Gitlab patched a critical vulnerability &ldquo;Account Takeover via Password Reset without user interactions&rdquo;, for which CVE 2023-7028 was assigned.</p>
<p>This looked interesting, so we decided to look into the issue and the patch. This was our first time setting up the env and looking into the gitlab codebase.</p>
<p>While analyzing this CVE, we also discovered another issue that could potentially result in &ldquo;Account Takeover on GitLab&rdquo; based on certain criteria which is explained after the CVE analysis.</p>
<p>Below is the POC of CVE 2023-7028 that was used to take over any user account.</p>
<p><img src="/img/cve-2023-7028/15.png" alt="image"></p>
<p>If you observe the screenshot, you&rsquo;ll see that the request is using <code>content-type</code> application/x-www-form-urlencoded, and within request, there&rsquo;s a parameter called user which contains an email address. Researcher added an extra [] which changed the email key from string type to list that contains multiple email addresses. So instead of just having the user&rsquo;s email like this:</p>
<p><img src="/img/cve-2023-7028/16.png" alt="19"></p>
<p>The attacker changed it to:
<img src="/img/cve-2023-7028/17.png" alt="20"></p>
<p>Let&rsquo;s review the code to know how the above POC lead to account takeover of any user.</p>
<ol>
<li>
<p>ActionController internal module is responsible for handling the controller request. It calls the method <code>create</code> of &ldquo;password_controller.rb&rdquo;
<img src="/img/cve-2023-7028/18.png" alt="1"></p>
</li>
<li>
<p>In the <code>create</code> method, <code>send_reset_password_instructions</code> method is getting called with post request body included as one of the fields in the &ldquo;resource_params&rdquo; parameter. Observe the debug console for the emails passed in the HTTP request body.
<img src="/img/cve-2023-7028/19.png" alt="2"></p>
</li>
<li>
<p>In the <code>send_reset_password_instructions</code> method, <code>attributes.delete</code> method extracts the <code>email</code> key from the <code>attributes</code> object passed as an argument and returns the list of emails supplied as shown below. <code>by_email_with_errors</code> method is called with the extracted email.
<img src="/img/cve-2023-7028/20.png" alt="3"></p>
</li>
<li>
<p>In this method, <code>by_email_with_errors</code> method is being called with the extracted emails.
<img src="/img/cve-2023-7028/21.png" alt="4"></p>
</li>
<li>
<p>In this method, it is again passing the emails to <code>find_by_any_email</code> method with a default parameter value <code>confirmed</code> set to <code>true</code>
<img src="/img/cve-2023-7028/22.png" alt="5"></p>
</li>
<li>
<p>In this method, <code>by_any_email</code> method is getting called.
<img src="/img/cve-2023-7028/23.png" alt="6"></p>
</li>
<li>
<p><code>by_user_email</code> method fetches the user records from the database if any user exists with the provided email address.
<img src="/img/cve-2023-7028/24.png" alt="7">
<img src="/img/cve-2023-7028/25.png" alt="8"></p>
</li>
<li>
<p>In the same manner, <code>by_emails</code> method fetched the user records based on the <code>emails</code> table with the join on <code>users</code> table in the database.
<img src="/img/cve-2023-7028/26.png" alt="9">
<img src="/img/cve-2023-7028/27.png" alt="10"></p>
</li>
<li>
<p>Now, the <code>user_id_for_emails</code> method fetches the user based on the private commit email(We will explain this later in detail)
<img src="/img/cve-2023-7028/28.png" alt="11"></p>
</li>
<li>
<p><code>items</code> list will contain the user records from the methods: <code>by_any_email</code>, <code>by_emails</code>,<code>user_id_for_emails</code>.
<img src="/img/cve-2023-7028/29.png" alt="12">
<img src="/img/cve-2023-7028/30.png" alt="13"></p>
</li>
<li>
<p>Now the first record is fetched and will be used to generate the reset token
<img src="/img/cve-2023-7028/31.png" alt="18"></p>
</li>
<li>
<p>The reset password token of the user will be sent to all the emails supplied
<img src="/img/cve-2023-7028/32.png" alt="14">
<img src="/img/cve-2023-7028/33.png" alt="15"></p>
</li>
</ol>
<h2 id="possible-account-takeover-of-any-user-by-using-private-commit-email"><a href="#possible-account-takeover-of-any-user-by-using-private-commit-email" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>Possible Account Takeover of any user By Using Private Commit Email</h2>
<h3 id="video-poc"><a href="#video-poc" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>Video POC</h3>
<video src="https://github.com/CVE-Reversing/CVE-Reversing/assets/43419559/7ca1a5d3-d99a-47cf-b72d-dbbd003a37e1" controls width="600">
  Your browser does not support the video tag.
</video>
<p>We observed  the below code snippet.<br>
<a href="https://gitlab.com/gitlab-org/gitlab/-/blob/d8c1bdad1cccaf9cf8f6c62af49907135b907b0e/app/models/user.rb#L750-763" target="_blank" rel="noopener">https://gitlab.com/gitlab-org/gitlab/-/blob/d8c1bdad1cccaf9cf8f6c62af49907135b907b0e/app/models/user.rb#L750-763</a></p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby">    <span class="k">def</span> <span class="nf">by_any_email</span><span class="p">(</span><span class="n">emails</span><span class="p">,</span> <span class="ss">confirmed</span><span class="p">:</span> <span class="kp">false</span><span class="p">)</span>
      <span class="n">from_users</span> <span class="o">=</span> <span class="n">by_user_email</span><span class="p">(</span><span class="n">emails</span><span class="p">)</span>
      <span class="n">from_users</span> <span class="o">=</span> <span class="n">from_users</span><span class="o">.</span><span class="n">confirmed</span> <span class="k">if</span> <span class="n">confirmed</span>

      <span class="n">from_emails</span> <span class="o">=</span> <span class="n">by_emails</span><span class="p">(</span><span class="n">emails</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="no">Email</span><span class="o">.</span><span class="n">confirmed</span><span class="p">)</span>
      <span class="n">from_emails</span> <span class="o">=</span> <span class="n">from_emails</span><span class="o">.</span><span class="n">confirmed</span> <span class="k">if</span> <span class="n">confirmed</span>

      <span class="n">items</span> <span class="o">=</span> <span class="o">[</span><span class="n">from_users</span><span class="p">,</span> <span class="n">from_emails</span><span class="o">]</span>

      <span class="n">user_ids</span> <span class="o">=</span> <span class="no">Gitlab</span><span class="o">::</span><span class="no">PrivateCommitEmail</span><span class="o">.</span><span class="n">user_ids_for_emails</span><span class="p">(</span><span class="nb">Array</span><span class="p">(</span><span class="n">emails</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:downcase</span><span class="p">))</span>
      <span class="n">items</span> <span class="o">&lt;&lt;</span> <span class="n">where</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">user_ids</span><span class="p">)</span> <span class="k">if</span> <span class="n">user_ids</span><span class="o">.</span><span class="n">present?</span>

      <span class="n">from_union</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
    <span class="k">end</span>
</code></pre></td></tr></table></div>
</div>
</div><p>In this code, the PrivateCommitEmail method is called, which extracts the user ID from the private commit email and returns the user based on the extracted user ID. After extracting the user, it creates a password reset token for the extracted user and sends it to the private commit email instead of sending it to the user&rsquo;s registered email.</p>
<h3 id="attack-scenarios"><a href="#attack-scenarios" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>Attack Scenarios</h3>
<p><strong>Scenario 1:</strong>
An attacker can takeover any other user account based on the user ID if they have obtained the mail in the private commit email format(<code>&lt;victimid&gt;-&lt;anything&gt;@custom_hostname</code>). In this case, attacker does not have to register the account on gitlab.</p>
<p><strong>Scenario 2:</strong>
An attacker can register using the private commit email format (<code>&lt;victimid&gt;-&lt;anything&gt;@custom_hostname</code>) of any user. Subsequently, during the password reset process, the attacker will receive the reset password of the victim user.</p>
<p>By default, custom name is set to <code>users.noreply.&lt;default_host&gt;</code>. In this case, the attacker should have access to <code>&lt;victimid&gt;&lt;anything&gt;@users.noreply.&lt;default_host&gt;</code>
<img src="/img/cve-2023-7028/12.png" alt=""></p>
<p>If the admin has set a custom host, the attacker should then have access to  <code>&lt;victimid&gt;&lt;anything&gt;@&lt;custom_host&gt;</code>. Here, the custom_host is set to &ldquo;example.com&rdquo;
<img src="/img/cve-2023-7028/13.png" alt=""></p>
<p>There is a logic flaw in <code>Scenario 2</code> in the password reset email functionality. Below is an explanation for the same:</p>
<ol>
<li>
<p>Observe that <code>by_user_email</code> and <code>by_emails</code> methods are called to fetch the user details based on the users and emails table from the database.
<img src="/img/cve-2023-7028/4.png" alt=""></p>
</li>
<li>
<p>The list <code>items</code> contains the attacker&rsquo;s user records. After this, <code>PrivateCommitEmails.user_id_for_emails</code> is called, which fetches the record based on the victim ID supplied in the email, and there is a hostname check based on the below method.
<img src="/img/cve-2023-7028/5.png" alt=""></p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"> <span class="k">def</span> <span class="nf">regex</span>
        <span class="n">hostname_regexp</span> <span class="o">=</span> <span class="no">Regexp</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="no">Gitlab</span><span class="o">::</span><span class="no">CurrentSettings</span><span class="o">.</span><span class="n">current_application_settings</span><span class="o">.</span><span class="n">commit_email_hostname</span><span class="p">)</span>

        <span class="sr">/\A(?&lt;id&gt;([0-9]+))\-([^@]+)@</span><span class="si">#{</span><span class="n">hostname_regexp</span><span class="si">}</span><span class="sr">\z/</span>
      <span class="k">end</span>
</code></pre></td></tr></table></div>
</div>
</div><ol start="3">
<li>
<p>Now, the list <code>items</code> contains the victim&rsquo;s User record as well.
<img src="/img/cve-2023-7028/6.png" alt=""></p>
</li>
<li>
<p>Now, the union query is executed. Observe below that the list <code>items</code> and the return list from the query are in the same order, which is an ideal scenario. However, sometimes the list <code>items</code> and the return list from the query are in a different order.
<img src="/img/cve-2023-7028/7.png" alt="">
<img src="/img/cve-2023-7028/8.png" alt=""></p>
</li>
<li>
<p>First record is fetched which is the victim user and will be used to generate the reset token
<img src="/img/cve-2023-7028/9.png" alt=""></p>
</li>
<li>
<p>After this, the reset password token of the victim user is sent to the attacker&rsquo;s email
<img src="/img/cve-2023-7028/10.png" alt="">
<img src="/img/cve-2023-7028/11.png" alt=""></p>
</li>
</ol>
<h4 id="cve-2023-7028-patch"><a href="#cve-2023-7028-patch" class="anchor-link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>CVE 2023-7028 Patch:</h4>
<p>We observed that the above attack is not working in the latest version due to the patch introduced for CVE 2023-7028.<br>
Below is the code snippet that does not call the<code> by_email_with_errors</code> method, which has the support for private commit emails.
Email record is fetched from the <code>emails</code> table if the email exists in the database and then the user record is fetched based on the join on the <code>users</code> table.<br>
The supplied email is being converted into a string, so even adding support for multiple email addresses by using [] won&rsquo;t work.</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">send_reset_password_instructions</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
      <span class="k">return</span> <span class="k">super</span> <span class="k">unless</span> <span class="n">attributes</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span>

      <span class="n">email</span> <span class="o">=</span> <span class="no">Email</span><span class="o">.</span><span class="n">confirmed</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="n">attributes</span><span class="o">[</span><span class="ss">:email</span><span class="o">].</span><span class="n">to_s</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">super</span> <span class="k">unless</span> <span class="n">email</span>

      <span class="n">recoverable</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">user</span>

      <span class="n">recoverable</span><span class="o">.</span><span class="n">send_reset_password_instructions</span><span class="p">(</span><span class="ss">to</span><span class="p">:</span> <span class="n">email</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
      <span class="n">recoverable</span>
</code></pre></td></tr></table></div>
</div>
</div><p><img src="/img/cve-2023-7028/14.png" alt="">
We reported this bug to gitlab on hackerone. It was marked as informative by gitlab since the patch for the CVE 2023-7028 also resolved this issue.</p>
<p>References:</p>
<ul>
<li><a href="https://docs.gitlab.com/ee/administration/settings/email.html#custom-hostname-for-private-commit-emails" target="_blank" rel="noopener">https://docs.gitlab.com/ee/administration/settings/email.html#custom-hostname-for-private-commit-emails</a></li>
<li><a href="https://gitpod.io/" target="_blank" rel="noopener">https://gitpod.io/</a></li>
</ul>

            </div>

            
    
    



        </article>

        

        


        


        


        
    
    



        


        


        


        
    
        
        
    
    
    
    
        <ul class="post-nav">
            
            
                <li class="post-nav-next">
                    <a href="/blogs/commandinjectionincopilotforxcodeextension/" rel="next">Command Injection In CopilotForXcode Extension &gt;</a>
                </li>
            
        </ul>
    



        
    

        <div class="load-comments">
            <div id="load-comments">Load Comments?</div>
        </div>

        
            <div id="disqus_thread"></div>
        

        

        

    



    </div>
</main>


            
    <div id="back-to-top" class="back-to-top">
        <a href="#"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon arrow-up"><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6 0-33.9L207 39c9.4-9.4 24.6-9.4 33.9 0l194.3 194.3c9.4 9.4 9.4 24.6 0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3 0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg></a>
    </div>


            
    <footer id="footer" class="footer">
        <div class="footer-inner">
            <div class="site-info">©&nbsp;2025&nbsp;</div>

            
    
        <ul class="socials"><li class="socials-item">
                    <a href="mailto:p3n7a90n@gmail.com" target="_blank" rel="external noopener" title="Email"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon social-icon"><path d="M464 64H48C21.49 64 0 85.49 0 112v288c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm0 48v40.805c-22.422 18.259-58.168 46.651-134.587 106.49-16.841 13.247-50.201 45.072-73.413 44.701-23.208.375-56.579-31.459-73.413-44.701C106.18 199.465 70.425 171.067 48 152.805V112h416zM48 400V214.398c22.914 18.251 55.409 43.862 104.938 82.646 21.857 17.205 60.134 55.186 103.062 54.955 42.717.231 80.509-37.199 103.053-54.947 49.528-38.783 82.032-64.401 104.947-82.653V400H48z"/></svg></a>
                </li><li class="socials-item">
                    <a href="https://twitter.com/p3n7a90n" target="_blank" rel="external noopener" title="Twitter"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon social-icon"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></a>
                </li><li class="socials-item">
                    <a href="https://github.com/p3n7a90n" target="_blank" rel="external noopener" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="icon social-icon"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
                </li><li class="socials-item">
                    <a href="https://linkedin.com/in/p3n7a90n" target="_blank" rel="external noopener" title="Linkedin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon social-icon"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg></a>
                </li></ul>
    



            
        </div>
    </footer>


        </div>
        

        






    

        
            <script>
    function loadComments() {
        if (typeof DISQUS === 'undefined') {
            var disqus_config = function() {
                this.page.url = 'https:\/\/p3n7a90n.github.com\/blogs\/cve-2023-7028\/';
                this.page.identifier = '\/blogs\/cve-2023-7028\/';
                this.page.title = 'Reversing CVE-2023-7028 \x26 Discovering Another Possible Account Takeover By Using Private Commit Email';
            };
            (function() {
                var d = document, s = d.createElement('script'); s.async = true;
                s.src = 'https://https-p3n7a90n-github-io.disqus.com/embed.js';
                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
            })();
        } else {
            DISQUS.reset({
                reload: true,
                config: function() {
                    this.page.url = 'https:\/\/p3n7a90n.github.com\/blogs\/cve-2023-7028\/';
                    this.page.identifier = '\/blogs\/cve-2023-7028\/';
                    this.page.title = 'Reversing CVE-2023-7028 \x26 Discovering Another Possible Account Takeover By Using Private Commit Email';
                }
            });
        }
    }
</script>

        

        

        

    



    <script src="https://cdn.jsdelivr.net/npm/medium-zoom@latest/dist/medium-zoom.min.js"></script>

<script>
    mediumZoom(document.querySelectorAll('div.post-body img'), {
        background: 'hsla(var(--color-bg-h), var(--color-bg-s), var(--color-bg-l), 0.95)'
    })
</script>




    <script src="https://cdn.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js" type="module" defer></script>







    </body>
</html>
